# Архитектура расчёта статистики (Baby Diary)

Период по умолчанию в приложении: **последние 7 дней**.

## Выбор стратегии расчёта

Подход выбран как **гибридный**:

- **Клиент (React)**: быстрые визуализации, таймлайн, карточки для текущего периода, когда уже есть локально загруженные активности.
- **База данных (Supabase/PostgreSQL)**: предрасчитанные ежедневные агрегаты, чтобы не пересчитывать большие объёмы данных при росте числа записей и пользователей.

Такой подход даёт:

1. Быстрый UX для мобильного экрана.
2. Снижение нагрузки на клиент при длинной истории.
3. Масштабируемость: добавление новых метрик через SQL-функции и таблицы агрегатов.

## Где считается каждая метрика

| Метрика | Где считать | Обоснование |
|---|---|---|
| 1. Среднее время кормления по груди в день | **Hybrid**: в БД агрегируется по дням, на клиенте строится график | Расчёт частый, по дням; выгодно хранить агрегаты и быстро рисовать бары |
| 2. Интервалы между кормлениями (avg/min/max) | **Client-side** (для последних 7 дней), опционально SQL-функция для длинных периодов | Требуется сортировка последовательности событий; для короткого окна это дешево на клиенте |
| 3. Объём бутылочки по дням | **Hybrid** | Простая дневная агрегация, хорошо ложится в daily-таблицу |
| 4. Суммарный сон по дням | **Hybrid** | Часто используемая сводка, нужен быстрый доступ для графика |
| 5. Таймлайн сна за день | **Client-side** | Нужны сырые интервалы начала/конца для отрисовки блоков по оси 0–24 |
| 6. Сон vs бодрствование | **Hybrid** | Дневные суммы можно брать из агрегатов; карточка собирается на клиенте |
| 7. Среднее бодрствование между снами | **Client-side**, при росте можно вынести в SQL-функцию | Интервальная метрика между соседними снами, зависит от упорядочивания событий |
| 8. Подгузники в день (total/wet/dirty) | **Hybrid** | Типичный счётчик по дням, выгодно хранить в агрегате |

## Почему не только client-side

При небольшом объёме данных клиентский расчёт работает быстро, но при активном использовании приложения (месяцы/годы истории):

- растёт время расчёта на экране статистики;
- растёт объём передаваемых данных;
- повышается риск расхождений в формулах между экранами.

Поэтому для production добавлены SQL-скрипты агрегирования и триггеры синхронизации.

## Консистентность данных

- Источник правды: `public.activities`.
- Производные данные: `public.daily_activity_stats` и `public.activity_interval_stats`.
- Триггеры на `INSERT/UPDATE/DELETE` в `activities` пересчитывают только затронутые даты/типы активности.

Это гарантирует консистентность между журналом активностей и статистикой.
